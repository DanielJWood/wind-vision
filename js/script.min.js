var totalDiv=document.getElementById("totalDiv"),boxWidth=40,width=parseInt(d3.select("#master_container").style("width")),height=width/2,projection=d3.geo.albersUsa(),path=d3.geo.path().projection(projection),svg=d3.select("#map_container").attr("width",width).attr("height",height),radius=d3.scale.sqrt().domain([0,1e3]).range([2,width/45]),legend=svg.append("g").attr("class","legend").selectAll("g").data([500,2e3,5e3]).enter().append("g"),imgWidth=50,imgHeight=50,defs=svg.append("defs").attr("id","mdef"),pattern=defs.append("pattern").attr("height",imgHeight).attr("width",imgWidth).attr("id","imageID1"),image=pattern.append("svg:image").attr("width",imgWidth-10).attr("height",imgHeight-10).attr("xlink:href","/sites/prod/files/mediaButtons_pause.png"),pattern2=defs.append("pattern").attr("height",imgHeight).attr("width",imgWidth).attr("id","imageID2").append("svg:image").attr("width",imgWidth-10).attr("height",imgHeight-10).attr("xlink:href","/sites/prod/files/mediaButtons_rewind.png"),pattern3=defs.append("pattern").attr("height",imgHeight).attr("width",imgWidth).attr("id","imageID3").append("svg:image").attr("width",imgWidth-10).attr("height",imgHeight-10).attr("xlink:href","/sites/prod/files/mediaButtons_ff.png");d3.json("js/us_93_02_v3.json",function(t,e){if(t)return console.error(t);var r=topojson.feature(e,e.objects.us_10m).features;d3.json("js/offshore2.json",function(t,a){function n(){(k="undefined")&&(k=1),d3.selectAll(".lg").remove(),d3.selectAll("#slider").remove(),d3.selectAll(".sly1").remove();var t=parseInt(d3.select("#master_container").style("width")),e=t/2;800>=t?projection.scale(1.2*t).translate([t/2,e/2+45]):900>=t?projection.scale(1.2*t).translate([t/2,e/2+30]):projection.scale(t).translate([t/2,e/2+10]);var a=t/20,n=10,i=a,l=40,o=1.5*a,d=3*l+o,c=t-a-d;svg.selectAll(".rw2").attr("transform",function(){return"translate("+(c+a+o/2)+","+n+")"}),svg.selectAll(".rpt2").attr("transform",function(){return"translate("+(c+a+l+o/2)+","+n+")"}),svg.selectAll(".ff2").attr("transform",function(){return"translate("+(c+a+2*l+o/2)+","+n+")"});svg.append("g").attr("id","slider").attr("class","sly1").append("rect").attr("transform",function(){return"translate("+i+","+n+")"}).attr("width",c).attr("height",2);svg.append("g").attr("id","sliderTick").attr("class","sly1").append("rect").attr("transform",function(){return"translate("+i+","+n+")"}).attr("width",2).attr("height",6),svg.append("g").attr("id","sliderTick2").attr("class","sly1").append("rect").attr("transform",function(){return"translate("+(c+a)+","+n+")"}).attr("width",2).attr("height",6);var p=d3.scale.sqrt().domain([0,1e3]).range([2,t/45]);legend.append("circle"),legend.append("text").attr("dy","1.3em").text(d3.format(".1s"));var u=[path.centroid(r[29])[0]+t/7,path.centroid(r[29])[1]+t/20];legend.attr("transform",function(){return"translate("+u+")"}),legend.selectAll("circle").attr("class","lg").attr("cy",function(t){return-p(t)}).attr("r",p),legend.selectAll("text").attr("class","lg").attr("y",function(t){return-2*p(t)}),svg.selectAll("path.state").attr("d",path),svg.selectAll("path.state-boundary").attr("d",path);var f=h[k][x];s(t,f)}function s(t,n){var s=$("select").val();if("to"==s)var i=1,l="Total Energy Produced";else if("co"==s)var i=2,l="Coal";else if("cr"==s)var i=3,l="Crude Oil";else if("na"==s)var i=4,l="Natural Gas";else if("tr"==s)var i=5,l="Total Renewable Energy";else if("or"==s)var i=6,l="Other Renewable Energy";else if("bi"==s)var i=8,l="Biofuels";else if("nu"==s)var i=7,l="Nuclear Power";var n=h[i][x],o=f(Math.round(a[2][n]/1e3));d3.selectAll(".sly").remove(),totalDiv.innerHTML="<h2>"+l+"</h2><h3>"+o+" Trillion BTU</h3>";var d=d3.scale.sqrt().domain([0,1e3]).range([2,t/45]),c=[path.centroid(r[28])[0]-30,path.centroid(r[28])[1]+t/10],p=[path.centroid(r[8])[0]-t/20,path.centroid(r[8])[1]+t/10];svg.selectAll("circle.bubble").data(topojson.feature(e,e.objects.us_10m).features.sort(function(t,e){return e.properties.total2012-t.properties.total2012})).attr("transform",function(t){return"translate("+path.centroid(t)+")"}).attr("r",function(t){var e=t.properties[n];return 0===e?0:d(e)}).attr("text",function(t){return t.properties.id}),svg.selectAll("circle.bubble2").attr("transform",function(){return"translate("+c+")"}).attr("r",function(){var t=a[0][n]/1e3;return 0===t?0:d(t)}).attr("j",0).attr("text",function(){return a[0].StateName}).text(function(){return a[0].StateName}),svg.selectAll("circle.bubble3").attr("transform",function(){return"translate("+p+")"}).attr("r",function(){var t=a[1][n]/1e3;return 0===t?0:d(t)}).attr("j",1).attr("text",function(){return a[1].StateName}).text(function(){return a[1].StateName});var u=t/20,g=40,m=1.5*u,v=3*g+m,b=t-u-v,j=u+b/w*x;svg.append("path").attr("d",d3.svg.symbol().type("triangle-up")).attr("id","slideTriangle").attr("class","sly").attr("transform",function(){return"translate("+(j+1)+",24)"}).attr("width",45).attr("height",20),svg.append("text").attr("class","tip-text sly").text(function(){return x+1993}).attr("transform",function(){return"translate("+j+",43)"})}function i(t){var e=$("select").val();if("to"==e)var r=1,n="Total Energy Produced";else if("co"==e)var r=2,n="Coal";else if("cr"==e)var r=3,n="Crude Oil";else if("na"==e)var r=4,n="Natural Gas";else if("tr"==e)var r=5,n="Total Renewable Energy";else if("or"==e)var r=6,n="Other Renewable Energy";else if("bi"==e)var r=8,n="Biofuels";else if("nu"==e)var r=7,n="Nuclear Power";var s=h[r][x];width=parseInt(d3.select("#master_container").style("width")),d3.selectAll(".tool").remove();var i=t;"bubble"!=this.className.animVal?(centroid=[this.transform.animVal[0].matrix.e,this.transform.animVal[0].matrix.f],toolName=this.innerHTML,"Gulf of Mexico"===toolName?j=0:"Pacific"===toolName&&(j=1),raw=a[j][s]/1e3):(centroid=path.centroid(i),toolName=i.properties.name,raw=i.properties[s]),centroid_adjusted=width>900?centroid[1]<250?[centroid[0]-85,centroid[1]+25]:[centroid[0]-85,centroid[1]-80]:width>700?centroid[1]<225?[centroid[0]-85,centroid[1]+25]:[centroid[0]-85,centroid[1]-80]:width>480?centroid[0]<width/2?[width-175,5]:[5,5]:centroid[0]<200?[width-175,5]:[5,5],tip_text=[centroid_adjusted[0]+80+5,centroid_adjusted[1]+20],tip_text2=[centroid_adjusted[0]+80+5,centroid_adjusted[1]+35],tip_close=[centroid_adjusted[0]+160,centroid_adjusted[1]+15];svg.append("g").attr("id","tooltip").attr("class","tool").append("rect").attr("transform",function(){return"translate("+centroid_adjusted+")"}).attr("width",170).attr("height",55).attr("rx",6).attr("ry",6);svg.append("text").attr("class","tip-text tool").text(function(){return toolName}).attr("transform",function(){return"translate("+tip_text+")"});var l=svg.append("text").attr("class","tip-text2 tool").attr("transform",function(){return"translate("+tip_text2+")"});l.append("tspan").text(function(){return n+":"}).attr("x",0).attr("y",0),l.append("tspan").text(function(){return raw+" Trillion Btu"}).attr("x",0).attr("y",15),svg.append("g").attr("class","closer tool").attr("transform",function(){return"translate("+tip_close+")"}).append("text").attr("class","tip-text2 tool").text("X").on("click",function(){d3.selectAll(".tool").remove()})}function l(){"undefined"!=b&&clearInterval(b),x===w&&(x-=w+1),b=setInterval(p,1e3)}function o(){0===y&&x!=w?(image.attr("xlink:href","/sites/prod/files/mediaButtons_play.png"),y+=1,clearInterval(b)):1===y&&x!=w?(image.attr("xlink:href","/sites/prod/files/mediaButtons_pause.png"),y-=1,b=setInterval(p,1e3)):(image.attr("xlink:href","/sites/prod/files/mediaButtons_pause.png"),x-=w+1,b=setInterval(p,1e3))}function d(){x===w?(image.attr("xlink:href","/sites/prod/files/mediaButtons_play.png"),x-=w,u(x)):(x+=1,u(x))}function c(){0===x?(image.attr("xlink:href","/sites/prod/files/mediaButtons_redo.png"),x+=w,u(x)):(x-=1,u(x))}function p(){x+=1,x===w&&(image.attr("xlink:href","/sites/prod/files/mediaButtons_redo.png"),clearInterval(b)),u(x)}function u(t){var e=h[k][t],r=parseInt(d3.select("#master_container").style("width"));s(r,e)}function f(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}if(t)return console.error(t+"error in offshore");!function(t){t("select").change(function(){if(x==w)l();else{var t=parseInt(d3.select("#master_container").style("width"));s(t)}})}(jQuery);var g=topojson.feature(e,e.objects.us_10m).features,h=[[],[],[],[],[],[],[],[],[]];for(var m in g[0].properties)"name"===m?h[0].push(m):"to"==m.substring(2,0)?h[1].push(m):"co"==m.substring(2,0)?h[2].push(m):"cr"==m.substring(2,0)?h[3].push(m):"na"==m.substring(2,0)?h[4].push(m):"tr"==m.substring(2,0)?h[5].push(m):"or"==m.substring(2,0)?h[6].push(m):"nu"==m.substring(2,0)?h[7].push(m):"bi"==m.substring(2,0)&&h[8].push(m);svg.selectAll(".state").data(topojson.feature(e,e.objects.us_10m).features).enter().append("path").attr("class",function(t){return"state "+t.id}),svg.append("path").datum(topojson.mesh(e,e.objects.us_10m,function(t,e){return t!==e})).attr("class","state-boundary");{var v=svg.append("g").attr("class","bubbles");svg.append("g").attr("class","bubbles2").append("circle").attr("class","bubble2"),svg.append("g").attr("class","bubbles3").append("circle").attr("class","bubble3"),svg.append("g").attr("class","rpt").attr("id","repeater").append("rect").attr("class","rpt2").attr("width",boxWidth).attr("height",boxWidth).style("fill","transparent").style("fill","url(#imageID1)"),svg.append("g").attr("class","rpt").attr("id","rewind").append("rect").attr("class","rw2").attr("width",boxWidth).attr("height",boxWidth).style("fill","transparent").style("fill","url(#imageID2)"),svg.append("g").attr("class","rpt").attr("id","fastforward").append("rect").attr("class","ff2").attr("width",boxWidth).attr("height",boxWidth).style("fill","transparent").style("fill","url(#imageID3)")}v.selectAll("circle").data(topojson.feature(e,e.objects.us_10m).features).enter().append("circle").attr("class","bubble");var b,w=19,x=0,y=0;n(),l(),d3.select(window).on("resize",n),d3.selectAll("circle.bubble").on("click",i),d3.selectAll("circle.bubble2").on("click",i),d3.selectAll("circle.bubble3").on("click",i),d3.selectAll(".rpt2").on("click",o),d3.selectAll(".rw2").on("click",c),d3.selectAll(".ff2").on("click",d)})});